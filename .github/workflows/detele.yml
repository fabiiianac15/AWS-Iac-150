name: MinTic Delete AWS CloudFormation Stacks

on:
  workflow_dispatch:

jobs:
  delete:
    runs-on: ubuntu-latest

    steps:
    - name: MinTic Checkout and download repository
      uses: actions/checkout@v3

    - name: MinTic Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Delete All Stacks in Reverse Order
      run: |
        echo "ÔøΩÔøΩÔ∏è Eliminando stacks en orden inverso..."
        
        # Stage 6: Delete ASG Stack
        echo "Eliminando ASG Stack..."
        aws cloudformation delete-stack --stack-name MinticASGStack || true
        aws cloudformation wait stack-delete-complete --stack-name MinticASGStack || true
        echo "‚úÖ ASG Stack eliminado"
        
        # Stage 5: Delete ALB Stack
        echo "Eliminando ALB Stack..."
        aws cloudformation delete-stack --stack-name MinticALBStack || true
        aws cloudformation wait stack-delete-complete --stack-name MinticALBStack || true
        echo "‚úÖ ALB Stack eliminado"
        
        # Stage 4: Delete EC2 Stack
        echo "Eliminando EC2 Stack..."
        aws cloudformation delete-stack --stack-name MinticEC2Stack || true
        aws cloudformation wait stack-delete-complete --stack-name MinticEC2Stack || true
        echo "‚úÖ EC2 Stack eliminado"
        
        # Stage 3: Delete Security Stack
        echo "Eliminando Security Stack..."
        aws cloudformation delete-stack --stack-name MinticSecurityStack || true
        aws cloudformation wait stack-delete-complete --stack-name MinticSecurityStack || true
        echo "‚úÖ Security Stack eliminado"
        
        # Stage 2: Delete VPC Stack
        echo "Eliminando VPC Stack..."
        aws cloudformation delete-stack --stack-name MinticVPCStack || true
        aws cloudformation wait stack-delete-complete --stack-name MinticVPCStack || true
        echo "‚úÖ VPC Stack eliminado"
        
        # Delete old monolithic stack if exists
        echo "Eliminando stack monol√≠tico antiguo (si existe)..."
        aws cloudformation delete-stack --stack-name MinticFullArchitecture || true
        aws cloudformation wait stack-delete-complete --stack-name MinticFullArchitecture || true
        
        echo ""
        echo "üéâ Todos los stacks eliminados exitosamente!"
